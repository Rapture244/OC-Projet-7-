name: CI/CD Heroku Deployment

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"  # or whatever Python version you plan to use

      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "2.0.0" # My poetry version at the time

      - name: Install dependencies
        run: poetry install

      - name: Run tests
        run: poetry run pytest tests/test_local_api.py --maxfail=1 --disable-warnings

  deploy:
    # Only run this after build-and-test passes
    needs: build-and-test
    runs-on: ubuntu-latest
    # Only deploy if we pushed to main
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "2.0.0" # My poetry version at the time

      - name: Install dependencies
        run: poetry install

      - name: Deploy to Heroku
        uses: AkhileshNS/heroku-deploy@v4.1.6
        with:
          # We'll use the Heroku API key you saved as a secret in GitHub
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          # This must match your Heroku App name exactly
          heroku_app_name: "credit-score-attribution"
          # The email associated with your Heroku account
          heroku_email: "pascal.ovidiuu@gmail.com"
          # Tells this action to do "git push heroku main"
          strategy: git
